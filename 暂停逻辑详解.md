# éŸ³é¢‘æ’­æ”¾æš‚åœé€»è¾‘è¯¦è§£

## æ¦‚è¿°

æš‚åœåŠŸèƒ½é€šè¿‡ `g_audiodev.status` è¿™ä¸ª**çŠ¶æ€æ§åˆ¶å˜é‡**å®ç°ï¼Œåˆ†ä¸ºä¸¤å±‚ï¼š
1. **åº”ç”¨å±‚**ï¼šæŒ‰é”®æ”¹å˜çŠ¶æ€æ ‡å¿—
2. **ç¡¬ä»¶å±‚**ï¼šDMA å›è°ƒæ ¹æ®çŠ¶æ€å¡«å……æ•°æ®

---

## å…³é”®æ•°æ®ç»“æ„

### g_audiodev ç»“æ„ä½“å®šä¹‰

```c
// åœ¨ audioplay.h ä¸­
typedef __packed struct
{  
    uint8_t *i2sbuf1;           /* I2Sè§£ç çš„BUF */
    uint8_t *i2sbuf2;
    uint8_t *tbuf;              /* ä¸´æ—¶æ•°ç»„,ä»…åœ¨24bitè§£ç çš„æ—¶å€™éœ€è¦ç”¨åˆ° */
    FIL *file;                  /* éŸ³é¢‘æ–‡ä»¶æŒ‡é’ˆ */

    uint8_t status;             /* ğŸ‘ˆ è¿™æ˜¯çŠ¶æ€æ§åˆ¶å­—èŠ‚ */
}__audiodev;
```

### status å­—æ®µçš„å«ä¹‰

```c
status æ˜¯ä¸€ä¸ª 8-bit çš„å­—èŠ‚ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

bit0 (æœ€ä½ä½):
  â”œâ”€ 0 = æš‚åœæ’­æ”¾ (PAUSE)
  â””â”€ 1 = ç»§ç»­æ’­æ”¾ (PLAY)

bit1:
  â”œâ”€ 0 = ç»“æŸæ’­æ”¾ (STOP)
  â””â”€ 1 = å¼€å¯æ’­æ”¾ (START)

bit2-7: æœªä½¿ç”¨
```

---

## æš‚åœé€»è¾‘æµç¨‹

### åˆå§‹åŒ–æ—¶

```c
// audioplay.c ä¸­çš„ audio_start()
void audio_start(void)
{
    g_audiodev.status = 3 << 0;  /* å·¦ç§» 0 ä½ï¼Œå€¼ä¸º 3 = 0b0011 */
    i2s_play_start();
}

// 0b0011 çš„å«ä¹‰ï¼š
//    bit1 = 1  â†’ å¼€å¯æ’­æ”¾
//    bit0 = 1  â†’ ç»§ç»­æ’­æ”¾ï¼ˆæ­£å¸¸æ’­æ”¾çŠ¶æ€ï¼‰
```

### æŒ‰ä¸‹ KEY1ï¼ˆæš‚åœ/ç»§ç»­åˆ‡æ¢ï¼‰

```c
// wavplay.c ä¸­çš„æ’­æ”¾å¾ªç¯
if (key == KEY1_PRES)   /* æš‚åœ/ç»§ç»­æ’­æ”¾ */
{
    if (g_audiodev.status & 0x01)   /* å½“å‰æ˜¯æ’­æ”¾çŠ¶æ€å—ï¼Ÿ */
    {
        g_audiodev.status &= ~(1 << 0);  /* æ¸…é™¤ bit0ï¼ŒçŠ¶æ€å˜ä¸º 0b0010 */
        // ç°åœ¨ï¼šbit0 = 0 â†’ æš‚åœæ’­æ”¾
    }
    else                               /* å½“å‰æ˜¯æš‚åœçŠ¶æ€ */
    {
        g_audiodev.status |= 0x01;     /* è®¾ç½® bit0ï¼ŒçŠ¶æ€å˜ä¸º 0b0011 */
        // ç°åœ¨ï¼šbit0 = 1 â†’ ç»§ç»­æ’­æ”¾
    }
}
```

### DMA å›è°ƒä¸­çš„æš‚åœå¤„ç† ğŸ”¥ æ ¸å¿ƒé€»è¾‘

```c
void wav_i2s_dma_tx_callback(void)  /* è¿™æ˜¯ä¸­æ–­å¤„ç†å‡½æ•° */
{
    uint16_t i;

    if (DMA1_Stream4->CR & (1 << 19))  /* æ£€æŸ¥æ˜¯ buf1 è¿˜æ˜¯ buf2 */
    {
        wavwitchbuf = 0;  /* æ­£åœ¨å¤„ç† buf1 */
        
        if ((g_audiodev.status & 0x01) == 0)  /* âŒ æš‚åœçŠ¶æ€ (bit0=0)? */
        {
            for (i = 0; i < WAV_I2S_TX_DMA_BUFSIZE; i++)
            {
                g_audiodev.i2sbuf1[i] = 0;  /* ğŸ‘ˆ å¡«å…… 0ï¼ˆé™éŸ³ï¼‰ */
            }
        }
        /* å¦‚æœæ˜¯æ’­æ”¾çŠ¶æ€ (bit0=1)ï¼Œå°±ä¸å¡«å…… 0ï¼Œä¿æŒåŸæœ‰çš„éŸ³é¢‘æ•°æ® */
    }
    else  /* å¤„ç† buf2 */
    {
        wavwitchbuf = 1;
        
        if ((g_audiodev.status & 0x01) == 0)  /* âŒ æš‚åœçŠ¶æ€? */
        {
            for (i = 0; i < WAV_I2S_TX_DMA_BUFSIZE; i++)
            {
                g_audiodev.i2sbuf2[i] = 0;  /* å¡«å…… 0ï¼ˆé™éŸ³ï¼‰ */
            }
        }
    }
    
    wavtransferend = 1;  /* æ ‡è®°ä¼ è¾“å®Œæˆ */
}
```

---

## æš‚åœçš„å·¥ä½œåŸç†è¯¦è§£

### åœºæ™¯ 1ï¸âƒ£ : æ­£å¸¸æ’­æ”¾

```
çŠ¶æ€: g_audiodev.status = 0b0011 (bit0=1, æ’­æ”¾ä¸­)

æ’­æ”¾å¾ªç¯:
  â†“
DMA å›è°ƒè§¦å‘ (æ¯æ¬¡ä¼ è¾“å®Œä¸€ä¸ª buffer)
  â†“
æ£€æŸ¥: (status & 0x01) == 0?  â†’  1 & 0x01 = 1  â†’  âŒ ä¸æˆç«‹
  â†“
è·³è¿‡å¡«å…… 0 çš„è¿‡ç¨‹ âœ…
  â†“
DMA ç»§ç»­ç”¨ä¹‹å‰çš„éŸ³é¢‘æ•°æ®å‘é€åˆ° I2S
  â†“
æ‰¬å£°å™¨æ’­æ”¾å£°éŸ³ ğŸ”Š
```

### åœºæ™¯ 2ï¸âƒ£ : æŒ‰ä¸‹ KEY1 æš‚åœ

```
ç”¨æˆ·æŒ‰ä¸‹ KEY1
  â†“
æ¡ä»¶åˆ¤æ–­: (g_audiodev.status & 0x01) == 1  â†’  âœ… æˆç«‹ï¼ˆæ’­æ”¾ä¸­ï¼‰
  â†“
æ‰§è¡Œ: g_audiodev.status &= ~(1 << 0)
     çŠ¶æ€ä» 0b0011 å˜æˆ 0b0010 (bit0 æ¸…é™¤)
  â†“
åç»­ DMA å›è°ƒ:
  â†“
æ£€æŸ¥: (status & 0x01) == 0?  â†’  (0b0010 & 1) == 0  â†’  âœ… æˆç«‹
  â†“
æ‰§è¡Œ: æŠŠä¸¤ä¸ª buffer éƒ½å¡«å…… 0
  â†“
DMA å‘é€çš„å…¨æ˜¯ 0 åˆ° I2S
  â†“
æ‰¬å£°å™¨æ²‰é»˜ ğŸ”‡ (éŸ³é¢‘æ’­æ”¾è¢«æš‚åœ)
```

### åœºæ™¯ 3ï¸âƒ£ : å†æŒ‰ KEY1 ç»§ç»­æ’­æ”¾

```
ç”¨æˆ·å†æŒ‰ä¸€æ¬¡ KEY1
  â†“
æ¡ä»¶åˆ¤æ–­: (g_audiodev.status & 0x01) == 0  â†’  âœ… æˆç«‹ï¼ˆæš‚åœä¸­ï¼‰
  â†“
æ‰§è¡Œ: g_audiodev.status |= 0x01
     çŠ¶æ€ä» 0b0010 å˜æˆ 0b0011 (bit0 è®¾ç½®)
  â†“
åç»­ DMA å›è°ƒ:
  â†“
æ£€æŸ¥: (status & 0x01) == 0?  â†’  (0b0011 & 1) == 0  â†’  âŒ ä¸æˆç«‹
  â†“
è·³è¿‡å¡«å…… 0 çš„è¿‡ç¨‹ âœ…
  â†“
DMA ç»§ç»­å‘é€ä¹‹å‰çš„éŸ³é¢‘æ•°æ®ï¼ˆæ–‡ä»¶æŒ‡é’ˆæ²¡åŠ¨ï¼‰
  â†“
æ‰¬å£°å™¨ç»§ç»­æ’­æ”¾ ğŸ”Šï¼ˆä»æš‚åœå¤„ç»§ç»­ï¼‰
```

---

## å…³é”®ç‰¹ç‚¹ ğŸ¯

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **åŸç†** | é€šè¿‡æ”¹å˜ DMA buffer çš„å†…å®¹æ¥å®ç°æš‚åœ |
| **æš‚åœæ–¹å¼** | å¡«å…… 0 è€Œä¸æ˜¯åœæ­¢ DMAï¼Œé¿å…çˆ†éŸ³ |
| **æ–‡ä»¶æŒ‡é’ˆ** | æš‚åœæ—¶**ä¸æ¨è¿›**æ–‡ä»¶æŒ‡é’ˆï¼Œæ‰€ä»¥ç»§ç»­æ’­æ”¾æ—¶**æ¥ç€æ’­æ”¾** |
| **ç«‹å³å“åº”** | åœ¨ DMA ä¸­æ–­ä¸­å¤„ç†ï¼Œæ‰€ä»¥æš‚åœå¾ˆå¿«å“åº” |
| **æ— éœ€å¤æ‚å¤„ç†** | ä¸éœ€è¦åœæ­¢/å¯åŠ¨ I2S æˆ– DMA |

---

## å®ç°ç»†èŠ‚å¯¹æ¯”

### ä¸ºä»€ä¹ˆç”¨ "å¡«å…… 0" è€Œä¸æ˜¯åœæ­¢ DMAï¼Ÿ

```
âŒ é”™è¯¯åšæ³•ï¼šåœæ­¢ DMA
   é—®é¢˜1: åœæ­¢ DMA éœ€è¦å¤æ‚çš„ç¡¬ä»¶é…ç½®
   é—®é¢˜2: åœæ­¢/é‡æ–°å¯åŠ¨ä¼šæœ‰å»¶è¿Ÿ
   é—®é¢˜3: å¯èƒ½é€ æˆçˆ†éŸ³(pop sound)
   é—®é¢˜4: æ–‡ä»¶æŒ‡é’ˆéœ€è¦ä¿å­˜å’Œæ¢å¤

âœ… æ­£ç¡®åšæ³•ï¼šç»§ç»­ DMAï¼Œä½†å‘é€ 0
   ä¼˜ç‚¹1: æå…¶ç®€å•ï¼Œåªéœ€æ”¹å˜ buffer å†…å®¹
   ä¼˜ç‚¹2: ç¡¬ä»¶ç»§ç»­å·¥ä½œï¼Œä¸éœ€è¦é…ç½®
   ä¼˜ç‚¹3: ç»§ç»­æ’­æ”¾æ—¶ç«‹å³æ¢å¤å£°éŸ³
   ä¼˜ç‚¹4: æ–‡ä»¶æŒ‡é’ˆè‡ªåŠ¨ä¿å­˜åœ¨åˆé€‚çš„ä½ç½®
   ä¼˜ç‚¹5: å“åº”å¿«ï¼Œå› ä¸ºåœ¨ä¸­æ–­ä¸­å¤„ç†
```

---

## æš‚åœæµç¨‹æ€»ç»“

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾  â”‚
                    â”‚ status=0b0011   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DMA æ’­æ”¾å¾ªç¯   â”‚
                    â”‚ (ä¸­æ–­å®šæ—¶è§¦å‘)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                        â”‚
                â†“                        â†“
        (bit0=1) æ’­æ”¾             (bit0=0) æš‚åœ
             â”‚                        â”‚
             â†“                        â†“
        å‘é€åŸæœ‰çš„éŸ³é¢‘æ•°æ®         å¡«å…… 0 æ•°æ®
             â”‚                        â”‚
             â†“                        â†“
        æ‰¬å£°å™¨è¾“å‡ºå£°éŸ³ğŸ”Š           æ‰¬å£°å™¨é™éŸ³ğŸ”‡
             â”‚                        â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                æŒ‰ KEY1 åˆ‡æ¢çŠ¶æ€
                    status toggle
```

---

## ä»£ç æ€»ç»“

```c
// æš‚åœé€»è¾‘çš„ä¸‰ä¸ªå…³é”®ä»£ç ç‰‡æ®µ

// 1ï¸âƒ£ æŒ‰é”®å¤„ç†ï¼ˆåº”ç”¨å±‚ï¼‰
if (key == KEY1_PRES)
{
    if (g_audiodev.status & 0x01)       // æ’­æ”¾ä¸­ï¼Ÿ
        g_audiodev.status &= ~(1 << 0);  // æ”¹ä¸ºæš‚åœ
    else
        g_audiodev.status |= 0x01;       // æ”¹ä¸ºæ’­æ”¾
}

// 2ï¸âƒ£ DMA ä¸­æ–­å¤„ç†ï¼ˆç¡¬ä»¶å±‚ï¼‰
void wav_i2s_dma_tx_callback(void)
{
    if ((g_audiodev.status & 0x01) == 0)  // æš‚åœçŠ¶æ€ï¼Ÿ
    {
        for (i = 0; i < WAV_I2S_TX_DMA_BUFSIZE; i++)
            g_audiodev.i2sbuf[i] = 0;      // å‘é€é™éŸ³æ•°æ®
    }
}

// 3ï¸âƒ£ åˆå§‹åŒ–
void audio_start(void)
{
    g_audiodev.status = 0b0011;  // 0 = æš‚åœï¼Œ1 = æ’­æ”¾
    i2s_play_start();
}
```

